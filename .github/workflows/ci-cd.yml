name: CI/CD Pipeline

# Qachon ishga tushadi?
on:
  push:
    branches: [ main ]        # main ga push bo'lsa
  pull_request:
    branches: [ main ]        # PR ochilsa

jobs:

  # ============================================
  # 1-JOB: TEST
  # ============================================
  test:
    name: ðŸ§ª Testlarni ishlatish
    runs-on: ubuntu-latest    # GitHub ning bepul Linux serveri

    steps:
      # Kodni yuklab olish
      - name: Kodni checkout qilish
        uses: actions/checkout@v3

      # Node.js o'rnatish
      - name: Node.js o'rnatish
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      # Dependencylarni o'rnatish
      - name: Dependencylarni o'rnatish
        run: cd app && npm install

      # Testlarni ishlatish
      - name: Testlarni ishlatish
        run: cd app && npm test

  # ============================================
  # 2-JOB: BUILD & PUSH (faqat test o'tsa)
  # ============================================
  build:
    name: ðŸ”¨ Build va Docker Hub ga push
    runs-on: ubuntu-latest
    needs: test               # test job muvaffaqiyatli bo'lsa bajariladi

    # Faqat main branch da (PR da build qilmaymiz)
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Kodni checkout qilish
        uses: actions/checkout@v3

      # Docker Hub ga login
      - name: Docker Hub ga login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Image ni build qilib push qilish
      - name: Build va push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/ci-cd-app:latest
            ${{ secrets.DOCKER_USERNAME }}/ci-cd-app:${{ github.sha }}

  # ============================================
  # 3-JOB: DEPLOY (faqat build o'tsa)
  # ============================================
  deploy:
    name: ðŸš€ Serverga deploy
    runs-on: ubuntu-latest
    needs: build              # build job muvaffaqiyatli bo'lsa

    if: github.ref == 'refs/heads/main'

    steps:
      - name: Serverga SSH orqali deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Yangi imageni pull qilamiz
            docker pull ${{ secrets.DOCKER_USERNAME }}/ci-cd-app:latest
            
            # Eski containerni to'xtatamiz
            docker stop ci-cd-app || true
            docker rm ci-cd-app || true
            
            # Yangi containerni ishga tushiramiz
            docker run -d \
              --name ci-cd-app \
              --restart unless-stopped \
              -p 3000:3000 \
              ${{ secrets.DOCKER_USERNAME }}/ci-cd-app:latest
            
            echo "âœ… Deploy muvaffaqiyatli!"
